<div id="cart-drawer" class="cart-drawer">
  <div class="cart-header">
    <h3>Warenkorb</h3>
    <button class="cart-close" onclick="closeCartDrawer()">Schließen</button>
  </div>

  <div class="cart-body" id="cart-body">
    <p>Lade Warenkorb...</p>
  </div>

  <div class="cart-footer" id="cart-footer">
    <div class="cart-subtotal">
      <strong>Zwischensumme:</strong>
      <span id="cart-total">–</span>
    </div>
    <div class="cart-buttons">
      <a href="/cart" class="btn-outline">Warenkorb ansehen</a>
      <a href="/checkout" class="btn">Zur Kasse</a>
    </div>
  </div>
</div>

<style>
.cart-drawer{
  position:fixed; right:-420px; top:0; height:100%; width:420px; max-width:92vw;
  background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,.12);
  display:flex; flex-direction:column; justify-content:space-between;
  transition:right .25s ease; z-index:9999;
}
.cart-drawer.open{ right:0; }
.cart-header{ display:flex; justify-content:space-between; align-items:center; padding:14px 20px; border-bottom:1px solid #ddd; background:var(--primary); color:#fff; }
.cart-body{ flex:1; overflow-y:auto; padding:20px; }
.cart-item{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }
.cart-item img{ width:64px; height:64px; object-fit:contain; border-radius:6px; }
.cart-footer{ padding:16px 20px; border-top:1px solid #ddd; }
.cart-subtotal{ display:flex; justify-content:space-between; margin-bottom:10px; font-size:16px; font-weight:600; }
.cart-buttons a{ display:inline-block; text-align:center; padding:10px 14px; border-radius:6px; text-decoration:none; font-weight:600; }
.btn{ background:var(--primary); color:#fff; }
.btn-outline{ border:1px solid var(--primary); color:var(--primary); margin-right:8px; }
.btn:hover{ opacity:.85; }
.cart-close{ background:#fff; border:none; color:#000; cursor:pointer; font-weight:700; border-radius:4px; padding:4px 10px; }
</style>

<script>
function money(cents){
  try {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format((cents||0)/100);
  } catch(e){
    // Fallback
    return (cents/100).toFixed(2).replace('.', ',') + ' €';
  }
}

async function loadCartDrawer(){
  try{
    const res = await fetch('/cart.js', { credentials: 'same-origin' });
    const cart = await res.json();
    const body = document.getElementById('cart-body');
    const total = document.getElementById('cart-total');
    if (!body || !total) return;

    if (!cart || cart.item_count === 0){
      body.innerHTML = '<p>Dein Warenkorb ist leer.</p>';
      total.textContent = money(0);
      return;
    }

    body.innerHTML = cart.items.map(item => {
      const img = item.image ? `<img src="${item.image}" alt="${item.title}">` : '';
      return `
        <div class="cart-item">
          ${img}
          <div>
            <p>${item.product_title || item.title}</p>
            <p>${item.quantity} × ${money(item.price)}</p>
          </div>
        </div>`;
    }).join('');

    total.textContent = money(cart.total_price);

    // Badge aktualisieren (falls Header vorhanden)
    const badge = document.querySelector('[data-cart-count]');
    if (badge){
      badge.textContent = cart.item_count;
      badge.classList.toggle('is-hidden', cart.item_count === 0);
    }
  } catch(e){
    console.error('Cart load error', e);
    const body = document.getElementById('cart-body');
    if (body) body.innerHTML = '<p>Ups, konnte den Warenkorb nicht laden.</p>';
  }
}

function closeCartDrawer(){
  const d = document.getElementById('cart-drawer');
  if (d){ d.classList.remove('open'); }
  document.documentElement.classList.remove('cart-open');
}

document.addEventListener('DOMContentLoaded', ()=>{
  const drawer = document.getElementById('cart-drawer');

  // Öffnen & laden
  document.querySelectorAll('[data-cart-toggle]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (!drawer) return;
      drawer.classList.add('open');
      document.documentElement.classList.add('cart-open');
      loadCartDrawer();
    });
  });

  // Aktualisieren nach Quick-Add
  document.addEventListener('hw:cart-updated', ()=>{
    loadCartDrawer();
  });
});
</script>
