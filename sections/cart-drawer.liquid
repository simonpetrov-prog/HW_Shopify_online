<div id="cart-drawer" class="cart-drawer">
  <div class="cart-header">
    <h3>Warenkorb</h3>
    <button class="cart-close" onclick="closeCartDrawer()">Schließen</button>
  </div>

  <div class="cart-body" id="cart-body">
    <p>Lade Warenkorb...</p>
  </div>

  <div class="cart-footer" id="cart-footer">
    <div class="cart-subtotal">
      <strong>Zwischensumme:</strong>
      <span id="cart-total">–</span>
    </div>
    <div class="cart-buttons">
      <a href="/cart" class="btn-outline">Warenkorb ansehen</a>
      <a href="/checkout" class="btn">Zur Kasse</a>
    </div>
  </div>
</div>

<style>
.cart-drawer{
  position:fixed; right:-420px; top:0; height:100%; width:420px; max-width:92vw;
  background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,.12);
  display:flex; flex-direction:column; justify-content:space-between;
  transition:right .25s ease; z-index:9999;
}
.cart-drawer.open{ right:0; }
.cart-header{ display:flex; justify-content:space-between; align-items:center; padding:14px 20px; border-bottom:1px solid #ddd; background:var(--primary); color:#fff; }
.cart-body{ flex:1; overflow-y:auto; padding:20px; }
.cart-item{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }
.cart-item img{ width:64px; height:64px; object-fit:contain; border-radius:6px; }
.cart-footer{ padding:16px 20px; border-top:1px solid #ddd; }
.cart-subtotal{ display:flex; justify-content:space-between; margin-bottom:10px; font-size:16px; font-weight:600; }
.cart-buttons a{ display:inline-block; text-align:center; padding:10px 14px; border-radius:6px; text-decoration:none; font-weight:600; }
.btn{ background:var(--primary); color:#fff; }
.btn-outline{ border:1px solid var(--primary); color:var(--primary); margin-right:8px; }
.btn:hover{ opacity:.85; }
.cart-close{ background:#fff; border:none; color:#000; cursor:pointer; font-weight:700; border-radius:4px; padding:4px 10px; }
</style>


<script>
function money(cents){
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format((cents||0)/100);
}

async function loadCartDrawer(){
  try {
    const res = await fetch('/cart.js');
    const cart = await res.json();
    const body = document.getElementById('cart-body');
    const total = document.getElementById('cart-total');

    if (!cart || !cart.items) return;

    if (cart.item_count === 0){
      body.innerHTML = '<p>Dein Warenkorb ist leer.</p>';
      total.textContent = money(0);
      return;
    }

    body.innerHTML = cart.items.map((item, i) => `
      <div class="cart-item">
        <img src="${item.image}" alt="${item.title}">
        <div class="cart-info">
          <p><strong>${item.product_title}</strong></p>
          <p>${money(item.price)}</p>
          <div class="cart-controls">
            <button onclick="updateQty(${i}, ${item.quantity - 1})" class="qty-btn">−</button>
            <span>${item.quantity}</span>
            <button onclick="updateQty(${i}, ${item.quantity + 1})" class="qty-btn">+</button>
            <button onclick="removeItem(${i})" class="remove-btn">✕</button>
          </div>
        </div>
      </div>
    `).join('');

    total.textContent = money(cart.total_price);

    const badge = document.querySelector('[data-cart-count]');
    if (badge) {
      badge.textContent = cart.item_count;
      badge.classList.toggle('is-hidden', cart.item_count === 0);
    }
  } catch (e) {
    console.error('Cart load error', e);
    document.getElementById('cart-body').innerHTML = '<p>Fehler beim Laden des Warenkorbs.</p>';
  }
}

async function updateQty(index, newQty){
  if (newQty <= 0) return removeItem(index);
  await fetch('/cart/change.js', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ line: index + 1, quantity: newQty })
  });
  loadCartDrawer();
}

async function removeItem(index){
  await fetch('/cart/change.js', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ line: index + 1, quantity: 0 })
  });
  loadCartDrawer();
}

function closeCartDrawer(){
  document.getElementById('cart-drawer').classList.remove('open');
  document.documentElement.classList.remove('cart-open');
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('[data-cart-toggle]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.getElementById('cart-drawer').classList.add('open');
      document.documentElement.classList.add('cart-open');
      loadCartDrawer();
    });
  });
});
</script>
