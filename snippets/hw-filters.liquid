{%- comment -%}
HW Central Seller – Filterbox
Nutzt die data-Attribute aus product-grid.liquid:
- data-color="{{ hw_color }}"
- data-brand="{{ hw_brand }}"
- data-rare="{{ hw_rare }}"
- data-price="{{ hw_price_cents }}"
{%- endcomment -%}

<div class="hw-filters-box">
  <div class="hw-filters-head">
    <h2>Filter</h2>
    <button type="button" class="hw-filter-reset">Zurücksetzen</button>
  </div>

  <!-- Tabs -->
  <div class="hw-filter-tabs">
    <button type="button" class="hw-filter-tab is-active" data-hw-tab="price">Preis</button>
    <button type="button" class="hw-filter-tab" data-hw-tab="color">Farbe</button>
    <button type="button" class="hw-filter-tab" data-hw-tab="brand">Marke</button>
    <button type="button" class="hw-filter-tab" data-hw-tab="rare">Seltenheit</button>
  </div>

  <!-- Panels -->
  <div class="hw-filter-panels">
    <!-- Preis -->
    <div class="hw-filter-panel" data-hw-panel="price">
      <div class="hw-filter-row">
        <label>
          Min (€)
          <input type="number" id="hw-price-min" min="0" step="0.5" placeholder="z. B. 2">
        </label>
        <label>
          Max (€)
          <input type="number" id="hw-price-max" min="0" step="0.5" placeholder="z. B. 10">
        </label>
      </div>
      <p class="hw-filter-hint">Filtert nach aktuellem Produktpreis.</p>
    </div>

    <!-- Farbe -->
    <div class="hw-filter-panel" data-hw-panel="color" hidden>
      <div class="hw-chip-row">
        {% assign colors = "Rot,Blau,Orange,Schwarz,Weiß,Grau,Grün,Gelb,Lila,Pink" | split: "," %}
        {% for c in colors %}
          <label class="hw-chip" data-hw-group="color">
            <input type="checkbox" value="{{ c }}">
            <span>{{ c }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Marke -->
    <div class="hw-filter-panel" data-hw-panel="brand" hidden>
      <div class="hw-chip-row">
        {% assign brands = "Porsche,Ferrari,BMW,Mercedes,Lamborghini,Toyota,Nissan,Audi,McLaren,Koenigsegg" | split: "," %}
        {% for b in brands %}
          <label class="hw-chip" data-hw-group="brand">
            <input type="checkbox" value="{{ b }}">
            <span>{{ b }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Seltenheit -->
    <div class="hw-filter-panel" data-hw-panel="rare" hidden>
      <div class="hw-chip-row">
        {% assign rares = "Mainline,TH,STH" | split: "," %}
        {% for r in rares %}
          <label class="hw-chip" data-hw-group="rare">
            <input type="checkbox" value="{{ r }}">
            <span>{{ r }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
.hw-filters-box{
  border:2px solid #0046BE;
  border-radius:16px;
  padding:12px 12px 14px;
  margin:10px 0 18px;
  background:#F7F9FF;

  /* wichtig damit nichts raussteht */
  max-width:100%;
  box-sizing:border-box;
  overflow:hidden;
}

/* Kopf */
.hw-filters-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.hw-filters-head h2{
  margin:0;
  font-size:16px;
  font-weight:800;
}
.hw-filter-reset{
  border:0;
  background:transparent;
  color:#6b7280;
  font-size:13px;
  cursor:pointer;
  text-decoration:underline;
}

/* Tabs */
.hw-filter-tabs{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:8px;
}
.hw-filter-tab{
  border-radius:999px;
  border:1px solid #d1d5db;
  padding:5px 12px;
  font-size:13px;
  font-weight:700;
  background:#fff;
  cursor:pointer;
}
.hw-filter-tab.is-active{
  background:#0046BE;
  color:#fff;
  border-color:#0046BE;
}

/* Panel-Container */
.hw-filter-panels{
  border-radius:12px;
  background:#fff;
  padding:10px;
  border:1px solid #e5e7eb;
  overflow-x:hidden; /* falls mal was zu breit wird */
}
.hw-filter-panel[hidden]{ display:none; }

/* Preis-Row */
.hw-filter-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;          /* sorgt dafür, dass nichts raussteht */
}
.hw-filter-row label{
  flex:1 1 160px;          /* beide Felder teilen sich die Breite sauber */
  display:flex;
  flex-direction:column;
  font-size:13px;
  gap:4px;
}
.hw-filter-row input{
  border-radius:8px;
  border:1px solid #d1d5db;
  padding:6px 8px;
  box-sizing:border-box;
}

.hw-filter-hint{
  margin:6px 0 0;
  font-size:12px;
  color:#6b7280;
}

/* Chips */
.hw-chip-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.hw-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  user-select:none;
}
.hw-chip input{ display:none; }
.hw-chip.is-active{
  background:#0046BE;
  border-color:#0046BE;
  color:#fff;
}

/* Mobile */
@media (max-width: 640px){
  .hw-filter-row{
    flex-direction:column;
  }
}

/* Fix gegen Überbreite im Preisfeld */
.hw-filter-row label {
  min-width: 0 !important;
}

.hw-filter-row {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  overflow: hidden;
}

.hw-filter-panel input[type="number"] {
  width: 100% !important;
  box-sizing: border-box;
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Tabs & Panels (Preis / Farbe / Marke / Seltenheit)
  const tabs   = Array.from(document.querySelectorAll('.hw-filter-tab'));
  const panels = Array.from(document.querySelectorAll('.hw-filter-panel'));

  function showPanel(id){
    panels.forEach(p => {
      p.hidden = p.dataset.hwPanel !== id;
    });
    tabs.forEach(t => {
      t.classList.toggle('is-active', t.dataset.hwTab === id);
    });
  }

  tabs.forEach(t => {
    t.addEventListener('click', () => showPanel(t.dataset.hwTab));
  });
  if (tabs.length){ showPanel(tabs[0].dataset.hwTab); }

  // Produktkarten
  const cards = Array.from(document.querySelectorAll('.product-card'));

  // Chips (Checkboxen in Farbe/Marke/Seltenheit)
  const chipInputs = Array.from(document.querySelectorAll('.hw-chip input[type="checkbox"]'));

  function collectSelections(){
    const selections = { color: [], brand: [], rare: [] };

    chipInputs.forEach(input => {
      if (!input.checked) return;

      // Chip-Label und Gruppe ermitteln
      const label = input.closest('.hw-chip');
      const group = label ? label.dataset.hwGroup : null; // "color", "brand", "rare"
      if (!group || !selections[group]) return;

      const v = (input.value || '').toLowerCase();
      selections[group].push(v);
    });

    return selections;
  }

  function applyFilters(){
    const sel = collectSelections();
    const selectedColors = sel.color;
    const selectedBrands = sel.brand;
    const selectedRares  = sel.rare;

    const minInput = document.getElementById('hw-price-min');
    const maxInput = document.getElementById('hw-price-max');
    const min = minInput && minInput.value ? parseFloat(minInput.value.replace(',', '.')) : null;
    const max = maxInput && maxInput.value ? parseFloat(maxInput.value.replace(',', '.')) : null;

    cards.forEach(card => {
      let visible = true;

      const color = (card.dataset.color || '').toLowerCase();
      const brand = (card.dataset.brand || '').toLowerCase();
      const rare  = (card.dataset.rare  || '').toLowerCase();
      const priceCents = card.dataset.price ? parseInt(card.dataset.price, 10) : null;
      const price = priceCents !== null ? priceCents / 100 : null;

      if (selectedColors.length && (!color || !selectedColors.includes(color))) {
        visible = false;
      }
      if (selectedBrands.length && (!brand || !selectedBrands.includes(brand))) {
        visible = false;
      }
      if (selectedRares.length && (!rare || !selectedRares.includes(rare))) {
        visible = false;
      }
      if (price !== null){
        if (min !== null && price < min) visible = false;
        if (max !== null && price > max) visible = false;
      }

      card.style.display = visible ? '' : 'none';
    });
  }

  // Chips: nur über input.change steuern (Label-Klick handled der Browser)
  chipInputs.forEach(input => {
    const label = input.closest('.hw-chip');
    if (!label) return;

    const sync = () => {
      label.classList.toggle('is-active', input.checked);
    };

    input.addEventListener('change', () => {
      sync();
      applyFilters();
    });

    // initialer Zustand
    sync();
  });

  // Preisfelder: bei Änderung filtern
  const minField = document.getElementById('hw-price-min');
  const maxField = document.getElementById('hw-price-max');

  [minField, maxField].forEach(field => {
    if (!field) return;
    field.addEventListener('change', applyFilters);
    field.addEventListener('blur', applyFilters);
  });

  // Reset
  const resetBtn = document.querySelector('.hw-filter-reset');

  if (resetBtn){
    resetBtn.addEventListener('click', function(e){
      e.preventDefault();

      // alle Checkboxen zurücksetzen
      chipInputs.forEach(input => {
        input.checked = false;
        const label = input.closest('.hw-chip');
        if (label) label.classList.remove('is-active');
      });

      // Preis zurücksetzen
      if (minField) minField.value = '';
      if (maxField) maxField.value = '';

      // alle Produkte wieder anzeigen
      cards.forEach(card => { card.style.display = ''; });
    });
  }
});
</script>
